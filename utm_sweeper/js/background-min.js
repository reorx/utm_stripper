console.log("load background.js");var DEBUG=!0,log=function(){DEBUG&&console.log.apply(console,arguments)},log_error=function(){console.error.apply(console,arguments)},tab_states={},getTabState=function(e){return e in tab_states||(tab_states[e]={popup_indicator:0}),tab_states[e]},deleteTabState=function(e){delete tab_states[e]},changeIcon=function(e,t){var n;n="question"==t?"images/icon_q_48_3.png":"images/icon_48.png",chrome.pageAction.setIcon({tabId:e,path:n})},getCurrentTab=function(e){chrome.tabs.query({active:!0,currentWindow:!0},function(t){e(t[0])})},onURLChanged=function(e,t){var n=t.url,a=t.id,o=getTabState(a),r;log("URL changed",e,t);var i=parseURL(n);log("url noquery:",i.url_noquery,"\nquery:",i.query,"\nfragment:",i.fragment,"\npopup_indicator:",o.popup_indicator),i.query?o.popup_indicator>0?setActionStatus(a,"visiable_popup"):setActionStatus(a,"visible_click"):setActionStatus(a,"invisible"),o.popup_indicator=0},setActionStatus=function(e,t){switch(console.log("setActionStatus",e,t),t){case"visible_click":chrome.pageAction.setPopup({tabId:e,popup:""}),changeIcon(e,"normal"),chrome.pageAction.show(e);break;case"visiable_popup":chrome.pageAction.setPopup({tabId:e,popup:"popup.html"}),changeIcon(e,"question"),chrome.pageAction.show(e);break;case"invisible":chrome.pageAction.hide(e);break;default:log_error("Bad status in setActionStatus:",t)}},DEFAULT_RULES=["ref","utm_\\w+","spm"],getRules=function(){return DEFAULT_RULES},parseURL=function(e){var t=e.indexOf("?");if(-1==t)return{url_noquery:e,query:"",fragment:""};var n=e.slice(0,t),a=e.slice(t);if(1==a.length)return{url_noquery:n,query:a,fragment:""};var o=a.indexOf("#"),r,i,s=r;return-1==o?(r=a,i=""):(r=a.slice(0,o),i=a.slice(o)),{url_noquery:n,query:r,fragment:i}},stripURL=function(e,t,n){var a=parseURL(e),o=a.url_noquery,r=a.query,i=a.fragment,s,c=getRules(e),u;if(t||n){var p=o;return t||(p+=r),n||(p+=i),p}return c.forEach(function(e){var t=e+"=[^&]*&?",n=new RegExp(t,"g");r=r.replace(n,""),log("pattern:",t,"stripped:",r)}),-1!=r.indexOf("&",r.length-1)&&(r=r.slice(0,-1)),"?"==r&&(r=""),o+r+i},stripTabURL=function(e,t,n,a){var o=stripURL(t,n,a),r=getTabState(e);t!=o?(r.popup_indicator=1,chrome.tabs.update(e,{url:o})):(r.popup_indicator=0,setActionStatus(e,"visiable_popup")),log("stripped:",o)};chrome.pageAction.onClicked.addListener(function(e){var t=e.id,n=e.url;log("click",t,arguments),stripTabURL(t,n)}),chrome.tabs.onUpdated.addListener(function(e,t,n){"loading"!=t.status||0!==n.url.indexOf("http:")&&0!==n.url.indexOf("https:")||onURLChanged("tabs.onUpdated",n)}),chrome.tabs.onRemoved.addListener(function(e,t){log("tab removed",e)}),chrome.runtime.onMessage.addListener(function(e,t,n){if(e.action)switch(e.action){case"sweep-all":getCurrentTab(function(e){stripTabURL(e.id,e.url,!0,!0)}),log("sweep-all");break;case"sweep-fragment":getCurrentTab(function(e){stripTabURL(e.id,e.url,!1,!0)}),log("sweep-fragment");break;default:log_error("Bad message action:",st)}});